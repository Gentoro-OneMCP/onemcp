#!/usr/bin/env bash
set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Error handling
error() {
    echo -e "${RED}❌ Error:${NC} $1" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}⚠️  Warning:${NC} $1" >&2
}

info() {
    echo -e "${BLUE}ℹ️  Info:${NC} $1"
}

success() {
    echo -e "${GREEN}✅${NC} $1"
}

# Find the repository root by looking for packages/server/pom.xml
find_repo_root() {
    local current_dir="${1:-$(pwd)}"
    local dir="$current_dir"
    
    # Try up to 10 levels up
    for i in {1..10}; do
        if [ -f "$dir/packages/server/pom.xml" ]; then
            echo "$dir"
            return 0
        fi
        if [ "$dir" = "/" ]; then
            break
        fi
        dir=$(dirname "$dir")
    done
    
    # If not found, try checking if ONEMCP_ROOT is set
    if [ -n "${ONEMCP_ROOT:-}" ] && [ -f "$ONEMCP_ROOT/packages/server/pom.xml" ]; then
        echo "$ONEMCP_ROOT"
        return 0
    fi
    
    error "Could not find OneMCP repository root. Please run this script from within the repository or set ONEMCP_ROOT environment variable."
}

# Check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if a port is in use
port_in_use() {
    local port="$1"
    if command_exists lsof; then
        lsof -i ":$port" >/dev/null 2>&1
    elif command_exists netstat; then
        netstat -tuln 2>/dev/null | grep -q ":$port " || netstat -an 2>/dev/null | grep -q ":$port "
    elif command_exists ss; then
        ss -tuln 2>/dev/null | grep -q ":$port "
    else
        # Fallback: try to connect to the port
        if command_exists nc; then
            nc -z localhost "$port" >/dev/null 2>&1
        else
            # Last resort: assume it's not in use if we can't check
            return 1
        fi
    fi
}

# Check if server is running by checking port 8080
is_server_running() {
    local port="${1:-8080}"
    if port_in_use "$port"; then
        # Additional check: try to hit the health endpoint
        if command_exists curl; then
            curl -s -f "http://localhost:$port/mcp" >/dev/null 2>&1 || \
            curl -s -f "http://localhost:$port/actuator/health" >/dev/null 2>&1
        else
            # If curl not available, just check port
            return 0
        fi
    else
        return 1
    fi
}

# Install npm dependencies if needed
ensure_npm_deps() {
    local cli_dir="$1"
    local node_modules="$cli_dir/node_modules"
    local package_json="$cli_dir/package.json"
    
    if [ ! -d "$node_modules" ] || [ "$package_json" -nt "$node_modules" ]; then
        info "Installing npm dependencies..."
        cd "$cli_dir"
        if ! npm install; then
            error "Failed to install npm dependencies. Make sure Node.js >= 20 is installed."
        fi
        success "npm dependencies installed"
    else
        info "npm dependencies are up to date"
    fi
}

# Build CLI if needed
ensure_cli_built() {
    local cli_dir="$1"
    local dist_index="$cli_dir/dist/index.js"
    local src_index="$cli_dir/src/index.ts"
    
    if [ ! -f "$dist_index" ] || [ "$src_index" -nt "$dist_index" ]; then
        info "Building CLI..."
        cd "$cli_dir"
        if ! npm run build; then
            error "Failed to build CLI. Check the build output above for errors."
        fi
        success "CLI built successfully"
    else
        info "CLI is already built"
    fi
}

# Build server JAR if needed
ensure_server_built() {
    local repo_root="$1"
    local server_dir="$repo_root/packages/server"
    local target_dir="$server_dir/target"
    local pom_file="$server_dir/pom.xml"
    
    # Check if JAR exists
    local jar_found=false
    if [ -d "$target_dir" ]; then
        # Look for jar-with-dependencies first, then regular jar
        if ls "$target_dir"/onemcp-*-jar-with-dependencies.jar >/dev/null 2>&1; then
            jar_found=true
        elif ls "$target_dir"/onemcp-*.jar >/dev/null 2>&1; then
            jar_found=true
        fi
    fi
    
    if [ "$jar_found" = false ]; then
        info "Server JAR not found. Building server..."
        
        # Check for Java and Maven
        if ! command_exists java; then
            error "Java is required but not found. Please install Java 21+: https://adoptium.net/"
        fi
        
        if ! command_exists mvn; then
            error "Maven is required but not found. Please install Maven: https://maven.apache.org/install.html"
        fi
        
        cd "$server_dir"
        if ! mvn clean package -DskipTests; then
            error "Failed to build server. Check the Maven output above for errors."
        fi
        success "Server built successfully"
    else
        info "Server JAR already exists"
    fi
}

# Note: We don't auto-start the server here because:
# 1. The 'start' command handles server startup with proper error handling
# 2. The 'chat' command starts the server automatically if needed
# 3. Commands like 'status' and 'logs' work fine without the server running
# 4. Auto-starting was causing hangs when health checks took too long
# Users should explicitly run 'onemcp start' if they want the server running

# Main execution
main() {
    # Save original directory
    local original_dir="$(pwd)"
    
    # Find repo root
    info "Finding repository root..."
    local repo_root
    repo_root=$(find_repo_root "$original_dir")
    success "Found repository root: $repo_root"
    
    # Set up paths
    local cli_dir="$repo_root/packages/cli"
    local server_dir="$repo_root/packages/server"
    
    # Verify directories exist
    if [ ! -d "$cli_dir" ]; then
        error "CLI directory not found: $cli_dir"
    fi
    
    if [ ! -d "$server_dir" ]; then
        error "Server directory not found: $server_dir"
    fi
    
    # Check for Node.js
    if ! command_exists node; then
        error "Node.js is required but not found. Please install Node.js >= 20: https://nodejs.org/"
    fi
    
    # Check Node.js version
    local node_version
    node_version=$(node -v | sed 's/v//' | cut -d. -f1)
    if [ "$node_version" -lt 20 ]; then
        error "Node.js version 20 or higher is required. Found version: $(node -v)"
    fi
    
    # Ensure npm dependencies are installed
    ensure_npm_deps "$cli_dir"
    
    # Ensure CLI is built
    ensure_cli_built "$cli_dir"
    
    # Ensure server is built
    ensure_server_built "$repo_root"
    
    # Note: We don't auto-start the server here because:
    # 1. The 'start' command handles server startup with proper error handling
    # 2. The 'chat' command starts the server automatically if needed
    # 3. Commands like 'status' and 'logs' work fine without the server running
    # 4. Auto-starting was causing hangs when health checks took too long
    # Users should explicitly run 'onemcp start' if they want the server running
    
    # Execute the CLI command
    local dist_index="$cli_dir/dist/index.js"
    cd "$cli_dir"
    
    # Make sure the script is executable
    chmod +x "$dist_index" 2>/dev/null || true
    
    # Run the CLI with all arguments
    exec node "$dist_index" "$@"
}

# Run main function with all arguments
main "$@"


