activations:
  - role: system
    activation: lexicon-extraction
    content: |
      Extract canonical lexicon from API spec for Prompt Schema Normalizer.
      
      If handbook instructions are provided, use them to understand domain-specific
      conventions, field naming patterns, and any special requirements for the API.
      The instructions may contain important context about how fields should be named
      or what types they represent.
      
      Extract:
      
      1. actions: Generic verbs (query, get, search, summarize, create, update,
         delete). Lower_snake_case. CRITICAL: Generic only, NO domain names.
         * WRONG: "query_sales_data", "get_customer_info"
         * CORRECT: "query", "get", "search"
         * If similar actions exist, combine (e.g., "get" + "query" → "query")
         * Only differentiate if meaningfully different (e.g., "delete" vs
           "remove_soft" if both exist)
         * NEVER add domain suffixes (_sales, _customer, etc.)
      
      2. entities: Resource types (nouns). One per API object. Lower_snake_case.
      
      3. fields: Actual data fields from entities. Lower_snake_case with
         underscores (sale_amount, product_name, customer_state).
         
         CRITICAL: Convert ALL dots to underscores:
         * API field "date.year" → lexicon field "date_year"
         * API field "customer.state" → lexicon field "customer_state"
         * API field "product.category" → lexicon field "product_category"
         * NEVER use dots in field names - always use underscores
         
         CRITICAL: Encode value type in field name suffix:
         * For ambiguous types (year, week, month that could be int or string):
           - Integer: Add `_int` suffix (e.g., `date_yyyy_int`, `date_week_int`, `date_month_int`)
           - String: Add `_str` suffix (e.g., `date_yyyy_str`, `date_week_str`, `date_month_str`)
         * For obviously string fields, use compound format suffixes:
           - `_yyyy_mm` → string (e.g., "2024-05")
           - `_yyyy_mm_dd` → string (e.g., "2024-12-31")
           - `_us_state_code` → string (e.g., "CA")
           - `_quarter` → string (e.g., "Q4")
           - `_day_of_week` → string (e.g., "Monday")
         * The suffix encodes the type so the normalizer can correctly normalize values
         
         DO NOT include:
         * Query params (filter, limit, offset, fields, aggregates)
         * Response wrappers (success, data, metadata, error, code, message)
         * Schema metadata (type, description, nullable, example, format)
         * Generic structures (field, operator, value, function, alias)
         * API control (timestamp, status, version, query_id, execution_time_ms)
         * Only business data fields users query/filter/aggregate
      
      Rules:
      - Lower_snake_case for all names
      - CRITICAL: Field names MUST use underscores, NEVER dots
      - Convert API field names with dots (e.g., "date.year") to underscores (e.g., "date_year")
      - CRITICAL: Add type-encoding suffixes to field names:
        * Ambiguous numeric fields (year, week, month) → add `_int` or `_str` suffix
        * Compound date formats → use format suffix (`_yyyy_mm`, `_yyyy_mm_dd`, etc.)
        * The suffix tells the normalizer how to normalize values (integer vs string)
      - Do not invent names not in API spec
      - Actions must be generic verbs, NOT domain-specific
      - Combine similar actions when possible
      - Return JSON: {"actions": [...], "entities": [...], "fields": [...]}
      - Output pure JSON, no markdown or code blocks

  - role: user
    activation: lexicon-extraction
    content: |
      {% if instructions_content is not empty %}
      ## Instructions
      ```
      {{ instructions_content | raw }}
      ```
      {% endif %}
      {% if openapi_files is not empty %}
      {% for openapi_file in openapi_files %}## OpenAPI: {{ openapi_file.name }}
      ```yaml
      {{ openapi_file.content | raw }}
      ```
      {% endfor %}
      {% endif %}
      
      Extract lexicon from API spec(s).
